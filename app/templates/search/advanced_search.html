{% extends "base/layout.html" %}

{% block title %}Advanced Search - SACEL Platform{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">ğŸ” Advanced Search</h1>
            <p class="mt-2 text-gray-600">Search across users, schools, assignments, and applications</p>
        </div>

        <!-- Search Interface -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
            <!-- Main Search Bar -->
            <div class="mb-6">
                <div class="relative">
                    <input type="text" id="globalSearchInput" 
                           class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-lg"
                           placeholder="Search for users, schools, assignments..."
                           autocomplete="off">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>
                    <div id="searchSuggestions" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md mt-1 hidden shadow-lg"></div>
                </div>
            </div>

            <!-- Search Type Tabs -->
            <div class="flex flex-wrap gap-1 mb-6">
                <button onclick="switchSearchType('global')" 
                        class="search-tab flex-1 sm:flex-none px-3 sm:px-4 py-2 text-xs sm:text-sm font-medium rounded-md bg-blue-100 text-blue-700 border border-blue-200" 
                        data-type="global">
                    <span class="hidden sm:inline">All Content</span>
                    <span class="sm:hidden">All</span>
                </button>
                <button onclick="switchSearchType('users')" 
                        class="search-tab flex-1 sm:flex-none px-3 sm:px-4 py-2 text-xs sm:text-sm font-medium rounded-md text-gray-600 hover:text-gray-900 border border-gray-200" 
                        data-type="users">
                    <span class="hidden sm:inline">ğŸ‘¤ Users</span>
                    <span class="sm:hidden">ğŸ‘¤</span>
                </button>
                <button onclick="switchSearchType('schools')" 
                        class="search-tab flex-1 sm:flex-none px-3 sm:px-4 py-2 text-xs sm:text-sm font-medium rounded-md text-gray-600 hover:text-gray-900 border border-gray-200" 
                        data-type="schools">
                    <span class="hidden sm:inline">ğŸ« Schools</span>
                    <span class="sm:hidden">ğŸ«</span>
                </button>
                <button onclick="switchSearchType('assignments')" 
                        class="search-tab flex-1 sm:flex-none px-3 sm:px-4 py-2 text-xs sm:text-sm font-medium rounded-md text-gray-600 hover:text-gray-900 border border-gray-200" 
                        data-type="assignments">
                    <span class="hidden sm:inline">ğŸ“š Assignments</span>
                    <span class="sm:hidden">ğŸ“š</span>
                </button>
                {% if current_user.role.value in ['school_admin', 'principal', 'system_admin'] %}
                <button onclick="switchSearchType('applications')" 
                        class="search-tab flex-1 sm:flex-none px-3 sm:px-4 py-2 text-xs sm:text-sm font-medium rounded-md text-gray-600 hover:text-gray-900 border border-gray-200" 
                        data-type="applications">
                    <span class="hidden sm:inline">ğŸ“‹ Applications</span>
                    <span class="sm:hidden">ğŸ“‹</span>
                </button>
                {% endif %}
            </div>

            <!-- Advanced Filters -->
            <div id="advancedFilters" class="border-t border-gray-200 pt-6 hidden">
                <!-- Common Filters -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Sort By</label>
                        <select id="sortBy" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                            <option value="created_at">Date Created</option>
                            <option value="updated_at">Last Updated</option>
                            <option value="name">Name</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Sort Order</label>
                        <select id="sortOrder" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                            <option value="desc">Newest First</option>
                            <option value="asc">Oldest First</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Results Per Page</label>
                        <select id="perPage" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                            <option value="10">10</option>
                            <option value="20" selected>20</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                </div>

                <!-- Type-specific Filters -->
                <div id="typeSpecificFilters" class="space-y-4">
                    <!-- Dynamic filters will be loaded here -->
                </div>

                <div class="flex space-x-3 mt-6">
                    <button onclick="applyAdvancedSearch()" 
                            class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 transition-colors">
                        Apply Filters
                    </button>
                    <button onclick="clearFilters()" 
                            class="bg-gray-300 text-gray-700 px-6 py-2 rounded-md hover:bg-gray-400 transition-colors">
                        Clear Filters
                    </button>
                    <button onclick="toggleAdvancedFilters()" 
                            class="text-blue-600 hover:text-blue-800 px-6 py-2 rounded-md border border-blue-300 hover:border-blue-400 transition-colors">
                        Hide Filters
                    </button>
                </div>
            </div>

            <div class="flex justify-between items-center mt-4">
                <button onclick="toggleAdvancedFilters()" 
                        id="toggleFiltersBtn"
                        class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                    ğŸ”½ Show Advanced Filters
                </button>
                
                <div class="flex space-x-2">
                    <button onclick="exportResults()" 
                            id="exportBtn"
                            class="text-gray-600 hover:text-gray-800 text-sm font-medium px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50 transition-colors hidden">
                        ğŸ“Š Export Results
                    </button>
                </div>
            </div>
        </div>

        <!-- Search Results -->
        <div id="searchResults" class="space-y-6">
            <!-- Global Search Results -->
            <div id="globalResults" class="hidden">
                <div id="globalUsersResults" class="bg-white rounded-lg shadow-sm p-6 mb-4 hidden">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">ğŸ‘¤ Users</h3>
                    <div id="globalUsersContent"></div>
                </div>
                <div id="globalSchoolsResults" class="bg-white rounded-lg shadow-sm p-6 mb-4 hidden">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">ğŸ« Schools</h3>
                    <div id="globalSchoolsContent"></div>
                </div>
                <div id="globalAssignmentsResults" class="bg-white rounded-lg shadow-sm p-6 mb-4 hidden">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">ğŸ“š Assignments</h3>
                    <div id="globalAssignmentsContent"></div>
                </div>
                <div id="globalApplicationsResults" class="bg-white rounded-lg shadow-sm p-6 mb-4 hidden">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">ğŸ“‹ Applications</h3>
                    <div id="globalApplicationsContent"></div>
                </div>
            </div>

            <!-- Specific Search Results -->
            <div id="specificResults" class="bg-white rounded-lg shadow-sm p-6">
                <div id="resultsHeader" class="flex justify-between items-center mb-4">
                    <h3 id="resultsTitle" class="text-lg font-semibold text-gray-900">Search Results</h3>
                    <div id="resultsCount" class="text-sm text-gray-600"></div>
                </div>
                <div id="resultsContent">
                    <!-- Welcome message -->
                    <div class="text-center py-12">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        <h3 class="mt-2 text-sm font-medium text-gray-900">Start Searching</h3>
                        <p class="mt-1 text-sm text-gray-500">
                            Enter a search term to find users, schools, assignments, and more.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Pagination -->
            <div id="pagination" class="hidden">
                <!-- Pagination controls will be dynamically inserted here -->
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="hidden fixed inset-0 bg-black bg-opacity-25 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 flex items-center space-x-3">
                <svg class="animate-spin h-5 w-5 text-blue-600" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="text-gray-700">Searching...</span>
            </div>
        </div>
    </div>
</div>

<script>
let currentSearchType = 'global';
let currentPage = 1;
let currentFilters = {};
let searchTimeout;

// Initialize search interface
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('globalSearchInput');
    
    // Search input event listeners
    searchInput.addEventListener('input', function(e) {
        clearTimeout(searchTimeout);
        const query = e.target.value.trim();
        
        if (query.length >= 2) {
            // Get suggestions with debounce
            searchTimeout = setTimeout(() => {
                getSuggestions(query);
            }, 300);
            
            // Perform search with debounce
            searchTimeout = setTimeout(() => {
                performSearch(query);
            }, 500);
        } else {
            hideSuggestions();
            clearResults();
        }
    });
    
    // Hide suggestions when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('#globalSearchInput') && !e.target.closest('#searchSuggestions')) {
            hideSuggestions();
        }
    });
    
    // Load initial filter options
    loadFilterOptions(currentSearchType);
});

function switchSearchType(type) {
    currentSearchType = type;
    currentPage = 1;
    
    // Update tab styles
    document.querySelectorAll('.search-tab').forEach(tab => {
        if (tab.dataset.type === type) {
            tab.className = 'search-tab px-4 py-2 text-sm font-medium rounded-md bg-blue-100 text-blue-700 border border-blue-200';
        } else {
            tab.className = 'search-tab px-4 py-2 text-sm font-medium rounded-md text-gray-600 hover:text-gray-900 border border-gray-200';
        }
    });
    
    // Load appropriate filter options
    loadFilterOptions(type);
    
    // Perform search if there's a query
    const query = document.getElementById('globalSearchInput').value.trim();
    if (query.length >= 2) {
        performSearch(query);
    } else {
        clearResults();
    }
}

async function performSearch(query, page = 1) {
    if (!query || query.length < 2) return;
    
    showLoading();
    currentPage = page;
    
    try {
        let results;
        
        if (currentSearchType === 'global') {
            results = await globalSearch(query);
            displayGlobalResults(results);
        } else {
            results = await specificSearch(query, currentSearchType, page);
            displaySpecificResults(results, currentSearchType);
        }
        
        // Show export button if there are results
        const exportBtn = document.getElementById('exportBtn');
        if (results && ((results.results && results.results.length > 0) || (results.total_results && results.total_results > 0))) {
            exportBtn.classList.remove('hidden');
        } else {
            exportBtn.classList.add('hidden');
        }
        
    } catch (error) {
        console.error('Search error:', error);
        showError('Search failed. Please try again.');
    } finally {
        hideLoading();
    }
}

async function globalSearch(query) {
    const searchTypes = [];
    if (currentUserRole !== 'student') searchTypes.push('users');
    searchTypes.push('schools', 'assignments');
    if (['school_admin', 'principal', 'system_admin'].includes(currentUserRole)) {
        searchTypes.push('applications');
    }
    
    const params = new URLSearchParams({
        q: query,
        limit: '5'
    });
    
    searchTypes.forEach(type => params.append('types', type));
    
    const response = await fetch(`/search/api/global?${params}`);
    if (!response.ok) {
        throw new Error('Global search failed');
    }
    
    return await response.json();
}

async function specificSearch(query, type, page = 1) {
    const params = new URLSearchParams({
        q: query,
        page: page.toString(),
        per_page: document.getElementById('perPage').value,
        sort_by: document.getElementById('sortBy').value,
        sort_order: document.getElementById('sortOrder').value
    });
    
    // Add current filters
    Object.entries(currentFilters).forEach(([key, value]) => {
        if (value && value !== '') {
            params.append(key, value);
        }
    });
    
    const response = await fetch(`/search/api/${type}?${params}`);
    if (!response.ok) {
        throw new Error(`${type} search failed`);
    }
    
    return await response.json();
}

function displayGlobalResults(results) {
    document.getElementById('globalResults').classList.remove('hidden');
    document.getElementById('specificResults').classList.add('hidden');
    
    // Display each content type
    const contentTypes = ['users', 'schools', 'assignments', 'applications'];
    contentTypes.forEach(type => {
        const container = document.getElementById(`global${type.charAt(0).toUpperCase() + type.slice(1)}Results`);
        const content = document.getElementById(`global${type.charAt(0).toUpperCase() + type.slice(1)}Content`);
        
        if (results.results[type] && results.results[type].length > 0) {
            container.classList.remove('hidden');
            content.innerHTML = renderResults(results.results[type], type);
        } else {
            container.classList.add('hidden');
        }
    });
    
    // Update results count
    const totalResults = results.total_results || 0;
    document.getElementById('resultsCount').textContent = `${totalResults} total results`;
}

function displaySpecificResults(results, type) {
    document.getElementById('globalResults').classList.add('hidden');
    document.getElementById('specificResults').classList.remove('hidden');
    
    const title = document.getElementById('resultsTitle');
    const content = document.getElementById('resultsContent');
    const count = document.getElementById('resultsCount');
    
    // Update title
    const typeNames = {
        users: 'ğŸ‘¤ Users',
        schools: 'ğŸ« Schools', 
        assignments: 'ğŸ“š Assignments',
        applications: 'ğŸ“‹ Applications'
    };
    title.textContent = typeNames[type] || 'Search Results';
    
    // Update count
    const total = results.pagination ? results.pagination.total : results.results.length;
    count.textContent = `${total} results found`;
    
    // Display results
    if (results.results && results.results.length > 0) {
        content.innerHTML = renderResults(results.results, type);
        
        // Show pagination if needed
        if (results.pagination && results.pagination.pages > 1) {
            displayPagination(results.pagination, type);
        } else {
            document.getElementById('pagination').classList.add('hidden');
        }
    } else {
        content.innerHTML = `
            <div class="text-center py-8">
                <div class="text-gray-400 text-4xl mb-4">ğŸ”</div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">No Results Found</h3>
                <p class="text-gray-600">Try adjusting your search terms or filters.</p>
            </div>
        `;
        document.getElementById('pagination').classList.add('hidden');
    }
}

function renderResults(results, type) {
    if (!results || results.length === 0) return '';
    
    return results.map(item => {
        switch (type) {
            case 'users':
                return renderUserResult(item);
            case 'schools':
                return renderSchoolResult(item);
            case 'assignments':
                return renderAssignmentResult(item);
            case 'applications':
                return renderApplicationResult(item);
            default:
                return '';
        }
    }).join('');
}

function renderUserResult(user) {
    const roleColors = {
        student: 'bg-blue-100 text-blue-800',
        teacher: 'bg-green-100 text-green-800',
        school_admin: 'bg-purple-100 text-purple-800',
        principal: 'bg-orange-100 text-orange-800',
        system_admin: 'bg-red-100 text-red-800'
    };
    
    return `
        <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="bg-gray-300 rounded-full w-10 h-10 flex items-center justify-center">
                        <span class="text-gray-600 font-medium">${user.first_name.charAt(0)}${user.last_name.charAt(0)}</span>
                    </div>
                    <div>
                        <h4 class="font-medium text-gray-900">${user.first_name} ${user.last_name}</h4>
                        <p class="text-sm text-gray-600">${user.email}</p>
                        ${user.school_name ? `<p class="text-xs text-gray-500">${user.school_name}</p>` : ''}
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="px-2 py-1 rounded-full text-xs font-medium ${roleColors[user.role] || 'bg-gray-100 text-gray-800'}">
                        ${user.role.replace('_', ' ').toUpperCase()}
                    </span>
                    <div class="w-2 h-2 rounded-full ${user.is_active ? 'bg-green-400' : 'bg-red-400'}"></div>
                </div>
            </div>
        </div>
    `;
}

function renderSchoolResult(school) {
    return `
        <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors">
            <div class="flex items-center justify-between">
                <div>
                    <h4 class="font-medium text-gray-900">${school.name}</h4>
                    <p class="text-sm text-gray-600">${school.province}, ${school.district}</p>
                    <div class="flex items-center space-x-4 mt-2 text-xs text-gray-500">
                        <span>ğŸ‘¨â€ğŸ“ ${school.student_count} students</span>
                        <span>ğŸ‘¨â€ğŸ« ${school.teacher_count} teachers</span>
                        <span class="px-2 py-1 rounded-full ${school.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${school.is_active ? 'Active' : 'Inactive'}
                        </span>
                    </div>
                </div>
                <div class="text-right">
                    <span class="text-xs text-gray-500">${school.school_type || 'Public'}</span>
                </div>
            </div>
        </div>
    `;
}

function renderAssignmentResult(assignment) {
    const dueDate = assignment.due_date ? new Date(assignment.due_date).toLocaleDateString() : 'No due date';
    const isOverdue = assignment.due_date && new Date(assignment.due_date) < new Date();
    
    return `
        <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors">
            <div class="flex items-start justify-between">
                <div class="flex-1">
                    <h4 class="font-medium text-gray-900">${assignment.title}</h4>
                    <p class="text-sm text-gray-600 mt-1">${assignment.description}</p>
                    <div class="flex items-center space-x-4 mt-2 text-xs text-gray-500">
                        <span>ğŸ“š ${assignment.subject}</span>
                        <span>ğŸ“ ${assignment.grade_level}</span>
                        ${assignment.teacher ? `<span>ğŸ‘¨â€ğŸ« ${assignment.teacher.name}</span>` : ''}
                        ${assignment.school_name ? `<span>ğŸ« ${assignment.school_name}</span>` : ''}
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-xs ${isOverdue ? 'text-red-600' : 'text-gray-500'} mb-1">
                        Due: ${dueDate}
                    </div>
                    ${assignment.total_points ? `<div class="text-xs text-gray-500">${assignment.total_points} points</div>` : ''}
                </div>
            </div>
        </div>
    `;
}

function renderApplicationResult(application) {
    const statusColors = {
        pending: 'bg-yellow-100 text-yellow-800',
        accepted: 'bg-green-100 text-green-800',
        rejected: 'bg-red-100 text-red-800',
        waitlisted: 'bg-blue-100 text-blue-800'
    };
    
    const submittedDate = application.created_at ? new Date(application.created_at).toLocaleDateString() : '';
    
    return `
        <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors">
            <div class="flex items-start justify-between">
                <div>
                    <h4 class="font-medium text-gray-900">${application.student_name}</h4>
                    <p class="text-sm text-gray-600">${application.parent_name} (${application.parent_email})</p>
                    <div class="flex items-center space-x-4 mt-2 text-xs text-gray-500">
                        <span>ğŸ“ ${application.grade_applying_for}</span>
                        <span>ğŸ« ${application.school_name}</span>
                        ${submittedDate ? `<span>ğŸ“… ${submittedDate}</span>` : ''}
                    </div>
                </div>
                <div class="text-right">
                    <span class="px-2 py-1 rounded-full text-xs font-medium ${statusColors[application.status] || 'bg-gray-100 text-gray-800'}">
                        ${application.status.toUpperCase()}
                    </span>
                </div>
            </div>
        </div>
    `;
}

// Additional helper functions for pagination, suggestions, etc.
// [Additional JavaScript functions would continue here...]

// Global variables for user role (would be set from server-side template)
const currentUserRole = '{{ current_user.role.value }}';
</script>
{% endblock %}