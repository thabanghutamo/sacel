{% extends "base/layout.html" %}

{% block title %}Advanced Assignment Creator - SACEL{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.snow.css" rel="stylesheet">
<style>
    .assignment-card {
        @apply bg-white rounded-lg shadow-md p-6 border border-gray-200;
    }
    .feature-toggle {
        @apply relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2;
    }
    .feature-toggle.enabled {
        @apply bg-indigo-600;
    }
    .feature-toggle.disabled {
        @apply bg-gray-200;
    }
    .feature-toggle-slider {
        @apply inline-block h-4 w-4 transform rounded-full bg-white transition;
    }
    .feature-toggle.enabled .feature-toggle-slider {
        @apply translate-x-6;
    }
    .feature-toggle.disabled .feature-toggle-slider {
        @apply translate-x-1;
    }
    .multimedia-upload-zone {
        @apply border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-gray-400 transition-colors cursor-pointer;
    }
    .multimedia-upload-zone.dragover {
        @apply border-indigo-500 bg-indigo-50;
    }
    .collaboration-settings {
        @apply bg-blue-50 border border-blue-200 rounded-lg p-4 mt-4;
    }
    .peer-review-settings {
        @apply bg-green-50 border border-green-200 rounded-lg p-4 mt-4;
    }
    .plagiarism-settings {
        @apply bg-yellow-50 border border-yellow-200 rounded-lg p-4 mt-4;
    }
    .ql-editor {
        min-height: 200px;
    }
</style>
{% endblock %}

{% block dashboard_content %}
<div class="container mx-auto px-4 py-8">
    <!-- Page Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Advanced Assignment Creator</h1>
        <p class="text-gray-600">Create multimedia assignments with collaboration, peer review, and plagiarism detection</p>
    </div>

    <!-- Assignment Creation Form -->
    <form id="assignment-form" class="space-y-8">
        <!-- Basic Information -->
        <div class="assignment-card">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Basic Information</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="title" class="block text-sm font-medium text-gray-700 mb-2">Assignment Title *</label>
                    <input type="text" id="title" name="title" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                    <label for="subject" class="block text-sm font-medium text-gray-700 mb-2">Subject *</label>
                    <select id="subject" name="subject" required 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <option value="">Select Subject</option>
                        <option value="Mathematics">Mathematics</option>
                        <option value="English">English</option>
                        <option value="Science">Science</option>
                        <option value="History">History</option>
                        <option value="Geography">Geography</option>
                        <option value="Life Skills">Life Skills</option>
                    </select>
                </div>
                <div>
                    <label for="grade_level" class="block text-sm font-medium text-gray-700 mb-2">Grade Level *</label>
                    <select id="grade_level" name="grade_level" required 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <option value="">Select Grade</option>
                        <option value="8">Grade 8</option>
                        <option value="9">Grade 9</option>
                        <option value="10">Grade 10</option>
                        <option value="11">Grade 11</option>
                        <option value="12">Grade 12</option>
                    </select>
                </div>
                <div>
                    <label for="max_score" class="block text-sm font-medium text-gray-700 mb-2">Maximum Score</label>
                    <input type="number" id="max_score" name="max_score" value="100" min="1" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                    <label for="due_date" class="block text-sm font-medium text-gray-700 mb-2">Due Date *</label>
                    <input type="datetime-local" id="due_date" name="due_date" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
            </div>
            
            <div class="mt-6">
                <label for="description" class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                <textarea id="description" name="description" rows="3" 
                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                          placeholder="Brief description of the assignment"></textarea>
            </div>
        </div>

        <!-- Rich Text Instructions -->
        <div class="assignment-card">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Instructions</h2>
            <div id="instructions-editor" class="bg-white"></div>
            <input type="hidden" id="instructions" name="instructions">
        </div>

        <!-- Multimedia Content -->
        <div class="assignment-card">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Multimedia Content</h2>
            
            <!-- File Upload Zone -->
            <div class="multimedia-upload-zone" id="upload-zone">
                <div class="mb-4">
                    <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                </div>
                <p class="text-lg text-gray-600 mb-2">Drag and drop files here, or click to browse</p>
                <p class="text-sm text-gray-500">Support for images, videos, audio files, and documents</p>
                <input type="file" id="file-input" multiple accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.ppt,.pptx" class="hidden">
            </div>
            
            <!-- Uploaded Files List -->
            <div id="uploaded-files" class="mt-4 space-y-2"></div>
            
            <!-- Video Embedding -->
            <div class="mt-6">
                <label for="video-url" class="block text-sm font-medium text-gray-700 mb-2">Embed Video (YouTube, Vimeo, etc.)</label>
                <div class="flex space-x-2">
                    <input type="url" id="video-url" placeholder="https://www.youtube.com/watch?v=..." 
                           class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <button type="button" id="add-video" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                        Add Video
                    </button>
                </div>
                <div id="embedded-videos" class="mt-4 space-y-2"></div>
            </div>
            
            <!-- Resource Links -->
            <div class="mt-6">
                <label for="resource-url" class="block text-sm font-medium text-gray-700 mb-2">Additional Resources</label>
                <div class="flex space-x-2">
                    <input type="url" id="resource-url" placeholder="https://example.com/resource" 
                           class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <input type="text" id="resource-title" placeholder="Resource Title" 
                           class="w-48 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <button type="button" id="add-resource" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                        Add Resource
                    </button>
                </div>
                <div id="resource-links" class="mt-4 space-y-2"></div>
            </div>
        </div>

        <!-- Collaboration Settings -->
        <div class="assignment-card">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold text-gray-900">Collaboration</h2>
                <button type="button" class="feature-toggle disabled" id="collaboration-toggle">
                    <span class="feature-toggle-slider"></span>
                </button>
            </div>
            
            <div id="collaboration-settings" class="collaboration-settings hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="max_collaborators" class="block text-sm font-medium text-gray-700 mb-2">Maximum Collaborators</label>
                        <input type="number" id="max_collaborators" name="max_collaborators" value="3" min="2" max="10" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="collaboration_deadline" class="block text-sm font-medium text-gray-700 mb-2">Collaboration Deadline</label>
                        <input type="datetime-local" id="collaboration_deadline" name="collaboration_deadline" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                </div>
                <div class="mt-4">
                    <p class="text-sm text-gray-600">
                        Students can form groups and submit collaborative work. Group formation must be completed by the collaboration deadline.
                    </p>
                </div>
            </div>
        </div>

        <!-- Peer Review Settings -->
        <div class="assignment-card">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold text-gray-900">Peer Review</h2>
                <button type="button" class="feature-toggle disabled" id="peer-review-toggle">
                    <span class="feature-toggle-slider"></span>
                </button>
            </div>
            
            <div id="peer-review-settings" class="peer-review-settings hidden">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="reviews_per_student" class="block text-sm font-medium text-gray-700 mb-2">Reviews per Student</label>
                        <input type="number" id="reviews_per_student" name="reviews_per_student" value="2" min="1" max="5" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="peer_review_deadline" class="block text-sm font-medium text-gray-700 mb-2">Review Deadline</label>
                        <input type="datetime-local" id="peer_review_deadline" name="peer_review_deadline" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="anonymous_reviews" name="anonymous_reviews" checked 
                               class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                        <label for="anonymous_reviews" class="ml-2 text-sm text-gray-700">Anonymous Reviews</label>
                    </div>
                </div>
                
                <!-- Review Criteria -->
                <div class="mt-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Review Criteria</label>
                    <div id="review-criteria" class="space-y-2">
                        <div class="flex items-center space-x-2">
                            <input type="text" placeholder="Criterion (e.g., Content Quality)" 
                                   class="flex-1 px-3 py-2 border border-gray-300 rounded-md">
                            <input type="number" placeholder="Max Points" value="10" min="1" max="100" 
                                   class="w-24 px-3 py-2 border border-gray-300 rounded-md">
                            <button type="button" class="px-3 py-2 text-red-600 hover:bg-red-50 rounded-md">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <button type="button" id="add-criterion" class="mt-2 px-4 py-2 text-sm bg-green-600 text-white rounded-md hover:bg-green-700">
                        Add Criterion
                    </button>
                </div>
            </div>
        </div>

        <!-- Plagiarism Detection -->
        <div class="assignment-card">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold text-gray-900">Plagiarism Detection</h2>
                <button type="button" class="feature-toggle enabled" id="plagiarism-toggle">
                    <span class="feature-toggle-slider"></span>
                </button>
            </div>
            
            <div id="plagiarism-settings" class="plagiarism-settings">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="similarity_threshold" class="block text-sm font-medium text-gray-700 mb-2">Similarity Threshold (%)</label>
                        <input type="number" id="similarity_threshold" name="similarity_threshold" value="80" min="50" max="100" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div class="space-y-2">
                        <div class="flex items-center">
                            <input type="checkbox" id="check_internal" name="check_internal" checked 
                                   class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                            <label for="check_internal" class="ml-2 text-sm text-gray-700">Check against other submissions</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="check_internet" name="check_internet" 
                                   class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                            <label for="check_internet" class="ml-2 text-sm text-gray-700">Check against internet sources</label>
                        </div>
                    </div>
                </div>
                <div class="mt-4">
                    <p class="text-sm text-gray-600">
                        Automatically check submissions for similarity to detect potential plagiarism. High similarity scores will be flagged for review.
                    </p>
                </div>
            </div>
        </div>

        <!-- Submission Types -->
        <div class="assignment-card">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Allowed Submission Types</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <label class="flex items-center">
                    <input type="checkbox" name="submission_types" value="text" checked 
                           class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                    <span class="ml-2 text-sm text-gray-700">Text</span>
                </label>
                <label class="flex items-center">
                    <input type="checkbox" name="submission_types" value="file" 
                           class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                    <span class="ml-2 text-sm text-gray-700">File Upload</span>
                </label>
                <label class="flex items-center">
                    <input type="checkbox" name="submission_types" value="video" 
                           class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                    <span class="ml-2 text-sm text-gray-700">Video</span>
                </label>
                <label class="flex items-center">
                    <input type="checkbox" name="submission_types" value="audio" 
                           class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                    <span class="ml-2 text-sm text-gray-700">Audio</span>
                </label>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="flex justify-end space-x-4">
            <button type="button" id="save-draft" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50">
                Save as Draft
            </button>
            <button type="submit" id="create-assignment" class="px-6 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                Create Assignment
            </button>
        </div>
    </form>
</div>

<script>
class AdvancedAssignmentCreator {
    constructor() {
        this.instructionsEditor = null;
        this.uploadedFiles = [];
        this.embeddedVideos = [];
        this.resourceLinks = [];
        this.reviewCriteria = [];
        this.init();
    }

    init() {
        this.initializeEditor();
        this.setupEventListeners();
        this.setupFileUpload();
        this.initializeToggles();
    }

    initializeEditor() {
        this.instructionsEditor = new Quill('#instructions-editor', {
            theme: 'snow',
            modules: {
                toolbar: [
                    ['bold', 'italic', 'underline', 'strike'],
                    ['blockquote', 'code-block'],
                    [{ 'header': 1 }, { 'header': 2 }],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    [{ 'script': 'sub'}, { 'script': 'super' }],
                    [{ 'indent': '-1'}, { 'indent': '+1' }],
                    ['link', 'image'],
                    ['clean']
                ]
            }
        });
    }

    setupEventListeners() {
        // Form submission
        document.getElementById('assignment-form').addEventListener('submit', (e) => {
            e.preventDefault();
            this.createAssignment();
        });

        // Feature toggles
        document.getElementById('collaboration-toggle').addEventListener('click', () => {
            this.toggleFeature('collaboration');
        });

        document.getElementById('peer-review-toggle').addEventListener('click', () => {
            this.toggleFeature('peer-review');
        });

        document.getElementById('plagiarism-toggle').addEventListener('click', () => {
            this.toggleFeature('plagiarism');
        });

        // Video embedding
        document.getElementById('add-video').addEventListener('click', () => {
            this.addVideo();
        });

        // Resource links
        document.getElementById('add-resource').addEventListener('click', () => {
            this.addResource();
        });

        // Review criteria
        document.getElementById('add-criterion').addEventListener('click', () => {
            this.addReviewCriterion();
        });

        // Save draft
        document.getElementById('save-draft').addEventListener('click', () => {
            this.saveDraft();
        });
    }

    setupFileUpload() {
        const uploadZone = document.getElementById('upload-zone');
        const fileInput = document.getElementById('file-input');

        uploadZone.addEventListener('click', () => {
            fileInput.click();
        });

        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            this.handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            this.handleFiles(e.target.files);
        });
    }

    initializeToggles() {
        // Initialize default states
        document.getElementById('collaboration-settings').classList.add('hidden');
        document.getElementById('peer-review-settings').classList.add('hidden');
        
        // Set due date to tomorrow
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 7);
        document.getElementById('due_date').value = tomorrow.toISOString().slice(0, 16);
        
        // Set collaboration deadline to 2 days before due date
        const collabDeadline = new Date(tomorrow);
        collabDeadline.setDate(collabDeadline.getDate() - 2);
        document.getElementById('collaboration_deadline').value = collabDeadline.toISOString().slice(0, 16);
        
        // Set peer review deadline to 3 days after due date
        const reviewDeadline = new Date(tomorrow);
        reviewDeadline.setDate(reviewDeadline.getDate() + 3);
        document.getElementById('peer_review_deadline').value = reviewDeadline.toISOString().slice(0, 16);
    }

    toggleFeature(feature) {
        const toggle = document.getElementById(`${feature}-toggle`);
        const settings = document.getElementById(`${feature}-settings`);
        
        if (toggle.classList.contains('enabled')) {
            toggle.classList.remove('enabled');
            toggle.classList.add('disabled');
            settings.classList.add('hidden');
        } else {
            toggle.classList.remove('disabled');
            toggle.classList.add('enabled');
            settings.classList.remove('hidden');
        }
    }

    handleFiles(files) {
        Array.from(files).forEach(file => {
            const fileData = {
                name: file.name,
                size: file.size,
                type: file.type,
                url: URL.createObjectURL(file)
            };
            
            this.uploadedFiles.push(fileData);
            this.renderUploadedFile(fileData);
        });
    }

    renderUploadedFile(fileData) {
        const container = document.getElementById('uploaded-files');
        const fileElement = document.createElement('div');
        fileElement.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-md';
        
        fileElement.innerHTML = `
            <div class="flex items-center space-x-3">
                <div class="flex-shrink-0">
                    ${this.getFileIcon(fileData.type)}
                </div>
                <div>
                    <p class="text-sm font-medium text-gray-900">${fileData.name}</p>
                    <p class="text-xs text-gray-500">${this.formatFileSize(fileData.size)}</p>
                </div>
            </div>
            <button type="button" class="text-red-600 hover:text-red-800" onclick="this.parentElement.remove()">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        `;
        
        container.appendChild(fileElement);
    }

    addVideo() {
        const videoUrl = document.getElementById('video-url').value;
        if (!videoUrl) return;

        const videoData = {
            url: videoUrl,
            embedUrl: this.convertToEmbedUrl(videoUrl)
        };

        this.embeddedVideos.push(videoData);
        this.renderEmbeddedVideo(videoData);
        document.getElementById('video-url').value = '';
    }

    addResource() {
        const url = document.getElementById('resource-url').value;
        const title = document.getElementById('resource-title').value;
        
        if (!url || !title) return;

        const resourceData = { url, title };
        this.resourceLinks.push(resourceData);
        this.renderResourceLink(resourceData);
        
        document.getElementById('resource-url').value = '';
        document.getElementById('resource-title').value = '';
    }

    addReviewCriterion() {
        const container = document.getElementById('review-criteria');
        const criterionElement = document.createElement('div');
        criterionElement.className = 'flex items-center space-x-2';
        
        criterionElement.innerHTML = `
            <input type="text" placeholder="Criterion (e.g., Content Quality)" 
                   class="flex-1 px-3 py-2 border border-gray-300 rounded-md">
            <input type="number" placeholder="Max Points" value="10" min="1" max="100" 
                   class="w-24 px-3 py-2 border border-gray-300 rounded-md">
            <button type="button" class="px-3 py-2 text-red-600 hover:bg-red-50 rounded-md" onclick="this.parentElement.remove()">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
            </button>
        `;
        
        container.appendChild(criterionElement);
    }

    async createAssignment() {
        try {
            const formData = this.collectFormData();
            
            const response = await fetch('/api/advanced-assignments/create-multimedia', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            });

            const result = await response.json();

            if (response.ok) {
                alert('Assignment created successfully!');
                window.location.href = `/teachers/assignments/${result.assignment_id}`;
            } else {
                alert(`Error: ${result.error}`);
            }
        } catch (error) {
            console.error('Error creating assignment:', error);
            alert('Failed to create assignment. Please try again.');
        }
    }

    collectFormData() {
        // Get instructions content
        document.getElementById('instructions').value = this.instructionsEditor.root.innerHTML;

        const formData = new FormData(document.getElementById('assignment-form'));
        const data = {};

        // Basic form data
        for (let [key, value] of formData.entries()) {
            if (key === 'submission_types') {
                if (!data[key]) data[key] = [];
                data[key].push(value);
            } else {
                data[key] = value;
            }
        }

        // Add multimedia content
        data.attachments = this.uploadedFiles;
        data.embedded_videos = this.embeddedVideos;
        data.resource_links = this.resourceLinks;

        // Add feature settings
        data.allow_collaboration = document.getElementById('collaboration-toggle').classList.contains('enabled');
        data.enable_peer_review = document.getElementById('peer-review-toggle').classList.contains('enabled');
        data.plagiarism_detection = document.getElementById('plagiarism-toggle').classList.contains('enabled');

        // Collect review criteria
        const criteriaElements = document.querySelectorAll('#review-criteria > div');
        data.review_criteria = Array.from(criteriaElements).map(element => {
            const inputs = element.querySelectorAll('input');
            return {
                name: inputs[0].value,
                max_points: parseInt(inputs[1].value)
            };
        }).filter(criterion => criterion.name);

        return data;
    }

    // Helper methods
    getFileIcon(type) {
        if (type.startsWith('image/')) {
            return '<svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>';
        } else if (type.startsWith('video/')) {
            return '<svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>';
        } else if (type.startsWith('audio/')) {
            return '<svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path></svg>';
        } else {
            return '<svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>';
        }
    }

    formatFileSize(bytes) {
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        if (bytes === 0) return '0 Bytes';
        const i = Math.floor(Math.log(bytes) / Math.log(1024));
        return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
    }

    convertToEmbedUrl(url) {
        // Convert YouTube URLs to embed format
        if (url.includes('youtube.com/watch')) {
            const videoId = url.split('v=')[1]?.split('&')[0];
            return `https://www.youtube.com/embed/${videoId}`;
        } else if (url.includes('youtu.be/')) {
            const videoId = url.split('youtu.be/')[1]?.split('?')[0];
            return `https://www.youtube.com/embed/${videoId}`;
        } else if (url.includes('vimeo.com/')) {
            const videoId = url.split('vimeo.com/')[1]?.split('?')[0];
            return `https://player.vimeo.com/video/${videoId}`;
        }
        return url;
    }

    renderEmbeddedVideo(videoData) {
        const container = document.getElementById('embedded-videos');
        const videoElement = document.createElement('div');
        videoElement.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-md';
        
        videoElement.innerHTML = `
            <div class="flex items-center space-x-3">
                <div class="flex-shrink-0">
                    <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                    </svg>
                </div>
                <div>
                    <p class="text-sm font-medium text-gray-900">Embedded Video</p>
                    <p class="text-xs text-gray-500">${videoData.url}</p>
                </div>
            </div>
            <button type="button" class="text-red-600 hover:text-red-800" onclick="this.parentElement.remove()">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        `;
        
        container.appendChild(videoElement);
    }

    renderResourceLink(resourceData) {
        const container = document.getElementById('resource-links');
        const resourceElement = document.createElement('div');
        resourceElement.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-md';
        
        resourceElement.innerHTML = `
            <div class="flex items-center space-x-3">
                <div class="flex-shrink-0">
                    <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                    </svg>
                </div>
                <div>
                    <p class="text-sm font-medium text-gray-900">${resourceData.title}</p>
                    <p class="text-xs text-gray-500">${resourceData.url}</p>
                </div>
            </div>
            <button type="button" class="text-red-600 hover:text-red-800" onclick="this.parentElement.remove()">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        `;
        
        container.appendChild(resourceElement);
    }

    saveDraft() {
        const formData = this.collectFormData();
        localStorage.setItem('assignment_draft', JSON.stringify(formData));
        alert('Draft saved successfully!');
    }
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', () => {
    new AdvancedAssignmentCreator();
});
</script>
{% endblock %}
