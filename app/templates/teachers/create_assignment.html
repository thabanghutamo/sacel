{% extends "base/layout.html" %}

{% block title %}Create Assignment - SACEL{% endblock %}

{% block dashboard_content %}
<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="bg-white shadow rounded-lg mb-6">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">Create New Assignment</h1>
                        <p class="text-gray-600 mt-1">Design and publish a new assignment for your students</p>
                    </div>
                    <a href="{{ url_for('teachers.assignments') }}" 
                       class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-arrow-left mr-2"></i>Back to Assignments
                    </a>
                </div>
            </div>
        </div>

        <!-- Assignment Creation Form -->
        <div class="bg-white shadow rounded-lg">
            <form id="assignmentForm" class="space-y-6 p-6">
                <!-- Basic Information -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="lg:col-span-2">
                        <label for="title" class="block text-sm font-medium text-gray-700 mb-2">
                            Assignment Title *
                        </label>
                        <input type="text" 
                               id="title" 
                               name="title" 
                               required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="Enter assignment title">
                    </div>

                    <div>
                        <label for="subject" class="block text-sm font-medium text-gray-700 mb-2">
                            Subject *
                        </label>
                        <select id="subject" 
                                name="subject" 
                                required
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Select Subject</option>
                            <option value="Mathematics">Mathematics</option>
                            <option value="English">English</option>
                            <option value="Afrikaans">Afrikaans</option>
                            <option value="IsiZulu">IsiZulu</option>
                            <option value="Natural Sciences">Natural Sciences</option>
                            <option value="Social Sciences">Social Sciences</option>
                            <option value="Technology">Technology</option>
                            <option value="Life Orientation">Life Orientation</option>
                            <option value="Arts and Culture">Arts and Culture</option>
                            <option value="Economic and Management Sciences">Economic and Management Sciences</option>
                        </select>
                    </div>

                    <div>
                        <label for="grade_level" class="block text-sm font-medium text-gray-700 mb-2">
                            Grade Level *
                        </label>
                        <select id="grade_level" 
                                name="grade_level" 
                                required
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Select Grade</option>
                            <option value="1">Grade 1</option>
                            <option value="2">Grade 2</option>
                            <option value="3">Grade 3</option>
                            <option value="4">Grade 4</option>
                            <option value="5">Grade 5</option>
                            <option value="6">Grade 6</option>
                            <option value="7">Grade 7</option>
                            <option value="8">Grade 8</option>
                            <option value="9">Grade 9</option>
                            <option value="10">Grade 10</option>
                            <option value="11">Grade 11</option>
                            <option value="12">Grade 12</option>
                        </select>
                    </div>

                    <div>
                        <label for="due_date" class="block text-sm font-medium text-gray-700 mb-2">
                            Due Date *
                        </label>
                        <input type="datetime-local" 
                               id="due_date" 
                               name="due_date" 
                               required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>

                    <div>
                        <label for="max_score" class="block text-sm font-medium text-gray-700 mb-2">
                            Maximum Score
                        </label>
                        <input type="number" 
                               id="max_score" 
                               name="max_score" 
                               value="100"
                               min="1"
                               max="1000"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                </div>

                <!-- Description -->
                <div>
                    <label for="description" class="block text-sm font-medium text-gray-700 mb-2">
                        Description
                    </label>
                    <textarea id="description" 
                              name="description" 
                              rows="3"
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                              placeholder="Brief description of the assignment"></textarea>
                </div>

                <!-- Instructions -->
                <div>
                    <label for="instructions" class="block text-sm font-medium text-gray-700 mb-2">
                        Instructions
                    </label>
                    <textarea id="instructions" 
                              name="instructions" 
                              rows="6"
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                              placeholder="Detailed instructions for students on how to complete this assignment"></textarea>
                </div>

                <!-- File Upload -->
                <div>
                    <label for="attachment" class="block text-sm font-medium text-gray-700 mb-2">
                        Attachment (Optional)
                    </label>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-gray-400 transition-colors">
                        <input type="file" 
                               id="attachment" 
                               name="attachment" 
                               class="hidden"
                               accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.txt,.png,.jpg,.jpeg">
                        <div id="fileDropZone">
                            <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                            <p class="text-gray-600 mb-2">Click to upload or drag and drop</p>
                            <p class="text-sm text-gray-500">PDF, Word, PowerPoint, Excel, Image files (Max 10MB)</p>
                        </div>
                        <div id="filePreview" class="hidden">
                            <div class="flex items-center justify-center">
                                <i class="fas fa-file text-2xl text-blue-500 mr-2"></i>
                                <span id="fileName" class="text-gray-700"></span>
                                <button type="button" 
                                        id="removeFile" 
                                        class="ml-2 text-red-500 hover:text-red-700">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Generation Tools -->
                <div class="bg-blue-50 rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-blue-900 mb-4">
                        <i class="fas fa-robot mr-2"></i>AI Assignment Tools
                    </h3>
                    
                    <!-- AI Generation Options -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Difficulty Level</label>
                            <select id="aiDifficulty" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="easy">Easy</option>
                                <option value="medium" selected>Medium</option>
                                <option value="hard">Hard</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Question Count</label>
                            <select id="aiQuestionCount" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="5">5 Questions</option>
                                <option value="10" selected>10 Questions</option>
                                <option value="15">15 Questions</option>
                                <option value="20">20 Questions</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Language</label>
                            <select id="aiLanguage" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="english" selected>English</option>
                                <option value="afrikaans">Afrikaans</option>
                                <option value="zulu">IsiZulu</option>
                                <option value="xhosa">IsiXhosa</option>
                                <option value="sotho">Sesotho</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Specific Topics (optional)</label>
                        <input type="text" id="aiSpecificTopics" placeholder="e.g., photosynthesis, cell division, plant anatomy"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <p class="text-sm text-gray-500 mt-1">Separate multiple topics with commas</p>
                    </div>
                    
                    <!-- AI Tool Buttons -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <button type="button" 
                                id="generateQuestions" 
                                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center justify-center">
                            <i class="fas fa-magic mr-2"></i>Generate Questions
                        </button>
                        <button type="button" 
                                id="generateRubric" 
                                class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center justify-center">
                            <i class="fas fa-clipboard-list mr-2"></i>Generate Rubric
                        </button>
                        <button type="button" 
                                id="enhanceInstructions" 
                                class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center justify-center">
                            <i class="fas fa-edit mr-2"></i>Enhance Instructions
                        </button>
                    </div>
                    
                    <!-- Loading indicator -->
                    <div id="aiGenerationLoading" style="display:none;" class="mb-4 flex items-center text-blue-600">
                        <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600 mr-2"></div>
                        <span id="loadingText">Processing with AI...</span>
                    </div>
                    
                    <!-- Generated content preview -->
                    <div id="generatedPreview" style="display:none;" class="p-4 bg-white border border-gray-200 rounded-lg">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-medium text-gray-900">AI Generated Content</h4>
                            <div class="flex space-x-2">
                                <button type="button" id="useGeneratedBtn" 
                                        class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700 transition">
                                    <i class="fas fa-check mr-1"></i>Use This
                                </button>
                                <button type="button" id="regenerateBtn" 
                                        class="bg-yellow-600 text-white px-3 py-1 rounded text-sm hover:bg-yellow-700 transition">
                                    <i class="fas fa-redo mr-1"></i>Regenerate
                                </button>
                                <button type="button" id="closePreviewBtn" 
                                        class="bg-gray-600 text-white px-3 py-1 rounded text-sm hover:bg-gray-700 transition">
                                    <i class="fas fa-times mr-1"></i>Close
                                </button>
                            </div>
                        </div>
                        <div id="generatedContent" class="text-sm text-gray-700 max-h-60 overflow-y-auto"></div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex justify-end space-x-4 pt-6 border-t border-gray-200">
                    <button type="button" 
                            id="saveDraft" 
                            class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-lg transition-colors">
                        <i class="fas fa-save mr-2"></i>Save Draft
                    </button>
                    <button type="submit" 
                            id="publishAssignment" 
                            class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition-colors">
                        <i class="fas fa-paper-plane mr-2"></i>Publish Assignment
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div id="loadingModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4">
        <div class="flex items-center">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mr-3"></div>
            <span class="text-gray-700">Creating assignment...</span>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('assignmentForm');
    const fileInput = document.getElementById('attachment');
    const fileDropZone = document.getElementById('fileDropZone');
    const filePreview = document.getElementById('filePreview');
    const fileName = document.getElementById('fileName');
    const removeFile = document.getElementById('removeFile');
    const loadingModal = document.getElementById('loadingModal');

    // File upload handling
    fileDropZone.addEventListener('click', () => fileInput.click());

    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            fileName.textContent = file.name;
            fileDropZone.classList.add('hidden');
            filePreview.classList.remove('hidden');
        }
    });

    removeFile.addEventListener('click', function() {
        fileInput.value = '';
        fileDropZone.classList.remove('hidden');
        filePreview.classList.add('hidden');
    });

    // Drag and drop handling
    fileDropZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        this.classList.add('border-blue-400', 'bg-blue-50');
    });

    fileDropZone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        this.classList.remove('border-blue-400', 'bg-blue-50');
    });

    fileDropZone.addEventListener('drop', function(e) {
        e.preventDefault();
        this.classList.remove('border-blue-400', 'bg-blue-50');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            fileName.textContent = files[0].name;
            fileDropZone.classList.add('hidden');
            filePreview.classList.remove('hidden');
        }
    });

    // Form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        submitAssignment(false);
    });

    // Save draft
    document.getElementById('saveDraft').addEventListener('click', function() {
        submitAssignment(true);
    });

    // AI Tools
    document.getElementById('generateQuestions').addEventListener('click', function() {
        generateAIContent('questions');
    });

    document.getElementById('generateRubric').addEventListener('click', function() {
        generateAIContent('rubric');
    });

    function submitAssignment(isDraft = false) {
        const formData = new FormData(form);
        const data = {
            title: formData.get('title'),
            description: formData.get('description'),
            subject: formData.get('subject'),
            grade_level: parseInt(formData.get('grade_level')),
            due_date: formData.get('due_date'),
            max_score: parseInt(formData.get('max_score')) || 100,
            instructions: formData.get('instructions'),
            is_draft: isDraft
        };

        loadingModal.classList.remove('hidden');
        loadingModal.classList.add('flex');

        fetch('/teachers/assignments', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            loadingModal.classList.add('hidden');
            loadingModal.classList.remove('flex');
            
            if (data.assignment_id) {
                alert(isDraft ? 'Assignment saved as draft!' : 'Assignment published successfully!');
                window.location.href = '/teachers/assignments';
            } else {
                alert('Error creating assignment: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            loadingModal.classList.add('hidden');
            loadingModal.classList.remove('flex');
            console.error('Error:', error);
            alert('Error creating assignment. Please try again.');
        });
    }

    function generateAIContent(type) {
        const subject = document.getElementById('subject').value;
        const gradeLevel = document.getElementById('grade_level').value;
        const title = document.getElementById('title').value;

        if (!subject || !gradeLevel) {
            alert('Please select subject and grade level first.');
            return;
        }

        // TODO: Implement AI content generation
        alert(`AI ${type} generation feature coming soon! This will generate ${type} based on ${subject} for Grade ${gradeLevel}.`);
    }

    // Set minimum due date to current datetime
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    document.getElementById('due_date').min = now.toISOString().slice(0, 16);
});
</script>
{% endblock %}
