{% extends "base/layout.html" %}
{% block title %}Grade Submission - {{ student.full_name }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <!-- Header -->
    <div class="mb-6">
        <div class="flex items-center space-x-4 mb-4">
            <a href="{{ url_for('teachers.grade_assignment_submissions', assignment_id=submission.assignment.id) }}" 
               class="text-indigo-600 hover:text-indigo-800 flex items-center">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
                Back to Assignment Grading
            </a>
        </div>
        <h1 class="text-3xl font-bold text-gray-900">Grade Submission</h1>
        <div class="flex items-center space-x-4 text-sm text-gray-500 mt-2">
            <span><strong>Student:</strong> {{ student.full_name }}</span>
            <span>•</span>
            <span><strong>Assignment:</strong> {{ submission.assignment.title }}</span>
            <span>•</span>
            <span><strong>Submitted:</strong> {{ submission.submitted_at.strftime('%Y-%m-%d %H:%M') if submission.submitted_at else 'Draft' }}</span>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Student Submission -->
        <div class="lg:col-span-2">
            <!-- Assignment Questions and Answers -->
            <div class="bg-white rounded-lg shadow mb-6">
                <div class="p-6 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">Student Responses</h3>
                </div>
                <div class="p-6 space-y-6" id="questionsContainer">
                    <!-- Questions will be populated here -->
                </div>
            </div>

            <!-- Files and Attachments -->
            {% if submission.attachment_url %}
            <div class="bg-white rounded-lg shadow mb-6">
                <div class="p-6 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">Submitted Files</h3>
                </div>
                <div class="p-6">
                    <div class="flex items-center space-x-3">
                        <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <div>
                            <p class="text-sm font-medium text-gray-900">{{ submission.attachment_url.split('/')[-1] }}</p>
                            <p class="text-sm text-gray-500">Uploaded file</p>
                        </div>
                        <a href="{{ submission.attachment_url }}" target="_blank" 
                           class="ml-auto inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded text-indigo-700 bg-indigo-100 hover:bg-indigo-200">
                            View File
                        </a>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Grading Panel -->
        <div class="lg:col-span-1">
            <!-- AI Assistance -->
            <div class="bg-white rounded-lg shadow mb-6">
                <div class="p-6 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">AI Grading Assistant</h3>
                </div>
                <div class="p-6">
                    <button id="getAiGradeBtn" class="w-full inline-flex justify-center items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                        Get AI Suggestion
                    </button>
                    
                    <div id="aiSuggestion" class="hidden mt-4 p-4 bg-purple-50 rounded-lg">
                        <h4 class="font-medium text-purple-900 mb-2">AI Suggestion</h4>
                        <div id="aiGradeDisplay" class="text-2xl font-bold text-purple-700 mb-2"></div>
                        <div id="aiFeedbackDisplay" class="text-sm text-purple-700 mb-3"></div>
                        <div id="aiConfidenceDisplay" class="text-xs text-purple-600"></div>
                        <button id="applyAiGradeBtn" class="mt-3 w-full px-3 py-1.5 bg-purple-600 text-white text-sm rounded hover:bg-purple-700">
                            Apply AI Grade
                        </button>
                    </div>
                </div>
            </div>

            <!-- Manual Grading -->
            <div class="bg-white rounded-lg shadow">
                <div class="p-6 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">Grade Submission</h3>
                </div>
                <div class="p-6">
                    <form id="gradingForm">
                        <!-- Grade Input -->
                        <div class="mb-4">
                            <label for="grade" class="block text-sm font-medium text-gray-700 mb-2">
                                Grade (out of {{ submission.assignment.max_score }})
                            </label>
                            <input type="number" id="grade" name="grade" 
                                   min="0" max="{{ submission.assignment.max_score }}" 
                                   step="0.5" value="{{ submission.grade or '' }}"
                                   class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            <p class="mt-1 text-xs text-gray-500">Maximum: {{ submission.assignment.max_score }} points</p>
                        </div>

                        <!-- Grade Calculator -->
                        <div class="mb-4 p-3 bg-gray-50 rounded-md">
                            <div class="flex justify-between text-sm">
                                <span>Percentage:</span>
                                <span id="gradePercentage" class="font-medium">-</span>
                            </div>
                            <div class="flex justify-between text-sm mt-1">
                                <span>Letter Grade:</span>
                                <span id="letterGrade" class="font-medium">-</span>
                            </div>
                        </div>

                        <!-- Feedback -->
                        <div class="mb-6">
                            <label for="feedback" class="block text-sm font-medium text-gray-700 mb-2">
                                Feedback for Student
                            </label>
                            <textarea id="feedback" name="feedback" rows="6" 
                                      placeholder="Provide constructive feedback to help the student improve..."
                                      class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">{{ submission.feedback or '' }}</textarea>
                        </div>

                        <!-- Action Buttons -->
                        <div class="space-y-3">
                            <button type="submit" 
                                    class="w-full inline-flex justify-center items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                                Save Grade
                            </button>
                            
                            {% if submission.grade %}
                            <button type="button" id="clearGradeBtn"
                                    class="w-full inline-flex justify-center items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                Clear Grade
                            </button>
                            {% endif %}
                        </div>
                    </form>
                </div>
            </div>

            <!-- Grading History -->
            {% if submission.graded_at %}
            <div class="bg-white rounded-lg shadow mt-6">
                <div class="p-6 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">Grading History</h3>
                </div>
                <div class="p-6">
                    <div class="text-sm text-gray-600">
                        <p><strong>Graded:</strong> {{ submission.graded_at.strftime('%Y-%m-%d %H:%M') }}</p>
                        <p><strong>Current Grade:</strong> {{ submission.grade }}/{{ submission.assignment.max_score }}</p>
                        {% if submission.graded_by %}
                        <p><strong>Graded by:</strong> You</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
class SubmissionGrading {
    constructor() {
        this.submissionId = {{ submission.id }};
        this.maxScore = {{ submission.assignment.max_score }};
        this.questions = [];
        this.answers = {};
        this.init();
    }

    init() {
        this.loadQuestions();
        this.bindEvents();
        this.updateGradeCalculations();
    }

    bindEvents() {
        // Grade input changes
        document.getElementById('grade').addEventListener('input', () => this.updateGradeCalculations());
        
        // Form submission
        document.getElementById('gradingForm').addEventListener('submit', (e) => this.handleSubmit(e));
        
        // AI assistance
        document.getElementById('getAiGradeBtn').addEventListener('click', () => this.getAiGrade());
        document.getElementById('applyAiGradeBtn')?.addEventListener('click', () => this.applyAiGrade());
        
        // Clear grade
        document.getElementById('clearGradeBtn')?.addEventListener('click', () => this.clearGrade());
    }

    async loadQuestions() {
        try {
            // Get assignment data with questions
            const assignmentResponse = await fetch(`/api/teachers/assignments/{{ submission.assignment.id }}/submissions`);
            const assignmentData = await assignmentResponse.json();
            
            if (assignmentData.success) {
                this.questions = assignmentData.assignment.questions || [];
                
                // Find this submission's answers
                const thisSubmission = assignmentData.submissions.find(s => s.id === this.submissionId);
                this.answers = thisSubmission?.answers || {};
                
                this.renderQuestions();
            }
        } catch (error) {
            console.error('Error loading questions:', error);
        }
    }

    renderQuestions() {
        const container = document.getElementById('questionsContainer');
        
        if (this.questions.length === 0) {
            container.innerHTML = '<p class="text-gray-500">No questions found for this assignment.</p>';
            return;
        }

        container.innerHTML = this.questions.map((question, index) => {
            const answer = this.answers[index.toString()] || 'No answer provided';
            return this.renderQuestionCard(question, answer, index);
        }).join('');
    }

    renderQuestionCard(question, answer, index) {
        const questionTypeLabels = {
            'multiple_choice': 'Multiple Choice',
            'short_answer': 'Short Answer', 
            'essay': 'Essay',
            'file_upload': 'File Upload'
        };

        const typeLabel = questionTypeLabels[question.type] || question.type;
        
        return `
            <div class="border border-gray-200 rounded-lg p-4">
                <div class="flex items-center justify-between mb-3">
                    <h4 class="font-medium text-gray-900">Question ${index + 1}</h4>
                    <div class="flex items-center space-x-2">
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            ${typeLabel}
                        </span>
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                            ${question.points || 0} pts
                        </span>
                    </div>
                </div>
                
                <div class="mb-3">
                    <p class="text-gray-900 font-medium">${question.question}</p>
                    ${question.type === 'multiple_choice' && question.options ? `
                        <div class="mt-2 space-y-1">
                            ${question.options.map((option, i) => `
                                <div class="text-sm text-gray-600">
                                    ${String.fromCharCode(65 + i)}. ${option}
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
                
                <div class="bg-gray-50 p-3 rounded-md">
                    <p class="text-sm font-medium text-gray-700 mb-1">Student Answer:</p>
                    <div class="text-sm text-gray-900">
                        ${question.type === 'file_upload' ? 
                            (answer && answer !== 'No answer provided' ? 
                                '<span class="text-green-600">✓ File uploaded</span>' : 
                                '<span class="text-red-600">✗ No file uploaded</span>') 
                            : answer}
                    </div>
                    ${question.correct_answer && question.type !== 'essay' && question.type !== 'file_upload' ? `
                        <div class="mt-2 pt-2 border-t border-gray-200">
                            <p class="text-sm font-medium text-gray-700 mb-1">Correct Answer:</p>
                            <div class="text-sm text-green-700">${question.correct_answer}</div>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    }

    updateGradeCalculations() {
        const gradeInput = document.getElementById('grade');
        const grade = parseFloat(gradeInput.value) || 0;
        
        // Calculate percentage
        const percentage = this.maxScore > 0 ? (grade / this.maxScore * 100) : 0;
        document.getElementById('gradePercentage').textContent = `${percentage.toFixed(1)}%`;
        
        // Calculate letter grade
        const letterGrade = this.calculateLetterGrade(percentage);
        document.getElementById('letterGrade').textContent = letterGrade;
    }

    calculateLetterGrade(percentage) {
        if (percentage >= 90) return 'A';
        if (percentage >= 80) return 'B';
        if (percentage >= 70) return 'C';
        if (percentage >= 60) return 'D';
        return 'F';
    }

    async getAiGrade() {
        try {
            document.getElementById('getAiGradeBtn').disabled = true;
            document.getElementById('getAiGradeBtn').textContent = 'Getting AI Suggestion...';
            
            const response = await fetch(`/api/teachers/submissions/${this.submissionId}/ai-grade`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                this.displayAiSuggestion(data.ai_grading);
            } else {
                alert('AI grading failed: ' + data.message);
            }
        } catch (error) {
            console.error('Error getting AI grade:', error);
            alert('Network error during AI grading');
        } finally {
            document.getElementById('getAiGradeBtn').disabled = false;
            document.getElementById('getAiGradeBtn').textContent = 'Get AI Suggestion';
        }
    }

    displayAiSuggestion(aiGrading) {
        document.getElementById('aiGradeDisplay').textContent = 
            `${aiGrading.suggested_grade}/${this.maxScore}`;
        document.getElementById('aiFeedbackDisplay').textContent = aiGrading.feedback;
        document.getElementById('aiConfidenceDisplay').textContent = 
            `Confidence: ${(aiGrading.confidence * 100).toFixed(0)}%`;
        
        document.getElementById('aiSuggestion').classList.remove('hidden');
        this.aiGradingData = aiGrading;
    }

    applyAiGrade() {
        if (this.aiGradingData) {
            document.getElementById('grade').value = this.aiGradingData.suggested_grade;
            document.getElementById('feedback').value = this.aiGradingData.feedback;
            this.updateGradeCalculations();
        }
    }

    async handleSubmit(e) {
        e.preventDefault();
        
        const grade = parseFloat(document.getElementById('grade').value);
        const feedback = document.getElementById('feedback').value.trim();
        
        if (isNaN(grade) || grade < 0 || grade > this.maxScore) {
            alert(`Please enter a valid grade between 0 and ${this.maxScore}`);
            return;
        }
        
        try {
            const response = await fetch(`/api/teachers/submissions/${this.submissionId}/grade`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ grade, feedback })
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert('Grade saved successfully!');
                // Optionally redirect back to assignment grading
                window.location.href = `/teachers/grading/assignment/{{ submission.assignment.id }}`;
            } else {
                alert('Failed to save grade: ' + data.error);
            }
        } catch (error) {
            console.error('Error saving grade:', error);
            alert('Network error saving grade');
        }
    }

    clearGrade() {
        if (confirm('Are you sure you want to clear this grade?')) {
            document.getElementById('grade').value = '';
            document.getElementById('feedback').value = '';
            this.updateGradeCalculations();
        }
    }
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', () => {
    new SubmissionGrading();
});
</script>
{% endblock %}
