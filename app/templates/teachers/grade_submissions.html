{% extends "base/layout.html" %}
{% block title %}Grade Assignment: {{ assignment.title }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <!-- Header -->
    <div class="mb-6">
        <div class="flex items-center space-x-4 mb-4">
            <a href="{{ url_for('teachers.grading_dashboard') }}" 
               class="text-indigo-600 hover:text-indigo-800 flex items-center">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
                Back to Grading Dashboard
            </a>
        </div>
        <h1 class="text-3xl font-bold text-gray-900">{{ assignment.title }}</h1>
        <div class="flex items-center space-x-4 text-sm text-gray-500 mt-2">
            <span>{{ assignment.subject }}</span>
            <span>•</span>
            <span>Grade {{ assignment.grade_level }}</span>
            <span>•</span>
            <span>Max Score: {{ assignment.max_score }}</span>
        </div>
    </div>

    <!-- Assignment Info Panel -->
    <div class="bg-white rounded-lg shadow mb-6">
        <div class="p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Assignment Details</h3>
            <div class="prose max-w-none text-gray-600">
                {{ assignment.description }}
            </div>
            {% if assignment.instructions %}
            <div class="mt-4">
                <h4 class="font-medium text-gray-900 mb-2">Instructions:</h4>
                <div class="text-gray-600 text-sm">{{ assignment.instructions }}</div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Grading Controls -->
    <div class="bg-white rounded-lg shadow mb-6">
        <div class="p-6 border-b border-gray-200">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                <div class="flex items-center space-x-4">
                    <h3 class="text-lg font-medium text-gray-900">Student Submissions</h3>
                    <span id="submissionCount" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                        Loading...
                    </span>
                </div>
                <div class="mt-4 sm:mt-0 flex items-center space-x-3">
                    <button id="aiGradeAllBtn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                        AI Grade All
                    </button>
                    <button id="exportBtn" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Export Grades
                    </button>
                </div>
            </div>
        </div>

        <!-- Filter and Sort -->
        <div class="p-6 border-b border-gray-200">
            <div class="flex items-center space-x-4">
                <div>
                    <label for="statusFilter" class="block text-sm font-medium text-gray-700">Status</label>
                    <select id="statusFilter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                        <option value="">All Submissions</option>
                        <option value="ungraded" selected>Ungraded</option>
                        <option value="graded">Graded</option>
                    </select>
                </div>
                <div>
                    <label for="sortBy" class="block text-sm font-medium text-gray-700">Sort By</label>
                    <select id="sortBy" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                        <option value="submitted_at">Submission Date</option>
                        <option value="student_name">Student Name</option>
                        <option value="grade">Grade</option>
                    </select>
                </div>
                <div class="flex-1">
                    <label for="searchInput" class="block text-sm font-medium text-gray-700">Search Student</label>
                    <input type="text" id="searchInput" placeholder="Search by name or email..." 
                           class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
            </div>
        </div>
    </div>

    <!-- Submissions List -->
    <div class="space-y-4">
        <!-- Loading State -->
        <div id="loadingState" class="bg-white rounded-lg shadow p-8 text-center">
            <svg class="animate-spin h-8 w-8 text-indigo-600 mx-auto" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-2 text-sm text-gray-500">Loading submissions...</p>
        </div>

        <!-- Submissions Container -->
        <div id="submissionsContainer" class="hidden space-y-4">
            <!-- Submissions will be populated here -->
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden bg-white rounded-lg shadow p-8 text-center">
            <svg class="w-12 h-12 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            <h3 class="text-lg font-medium text-gray-900 mb-2">No submissions found</h3>
            <p class="text-gray-500">No submissions match your current filters.</p>
        </div>
    </div>

    <!-- AI Grading Progress Modal -->
    <div id="aiGradingModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4">AI Grading in Progress</h3>
                <div class="space-y-3">
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div id="aiGradingProgress" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                    <p id="aiGradingStatus" class="text-sm text-gray-600">Starting AI grading...</p>
                    <div id="aiGradingResults" class="space-y-2 text-sm">
                        <!-- Results will be populated here -->
                    </div>
                </div>
                <div class="mt-4 flex justify-end">
                    <button id="closeAiGradingBtn" class="px-4 py-2 text-sm text-gray-500 hover:text-gray-700 disabled:opacity-50" disabled>
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
class AssignmentGrading {
    constructor() {
        this.assignmentId = {{ assignment.id }};
        this.submissions = [];
        this.filteredSubmissions = [];
        this.questions = [];
        this.init();
    }

    init() {
        this.bindEvents();
        this.loadSubmissions();
    }

    bindEvents() {
        // Filter and search events
        document.getElementById('statusFilter').addEventListener('change', () => this.applyFilters());
        document.getElementById('sortBy').addEventListener('change', () => this.applyFilters());
        document.getElementById('searchInput').addEventListener('input', () => this.applyFilters());

        // Action buttons
        document.getElementById('aiGradeAllBtn').addEventListener('click', () => this.startAiGrading());
        document.getElementById('exportBtn').addEventListener('click', () => this.exportGrades());
        document.getElementById('closeAiGradingBtn').addEventListener('click', () => this.closeAiGradingModal());
    }

    async loadSubmissions() {
        try {
            this.showLoading(true);
            
            const response = await fetch(`/api/teachers/assignments/${this.assignmentId}/submissions`);
            const data = await response.json();
            
            if (data.success) {
                this.submissions = data.submissions;
                this.questions = data.assignment.questions || [];
                this.updateSubmissionCount();
                this.applyFilters();
            } else {
                this.showError('Failed to load submissions');
            }
        } catch (error) {
            console.error('Error loading submissions:', error);
            this.showError('Network error loading submissions');
        } finally {
            this.showLoading(false);
        }
    }

    applyFilters() {
        const statusFilter = document.getElementById('statusFilter').value;
        const sortBy = document.getElementById('sortBy').value;
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();

        // Filter submissions
        this.filteredSubmissions = this.submissions.filter(submission => {
            const matchesStatus = !statusFilter || 
                (statusFilter === 'ungraded' && !submission.grade) ||
                (statusFilter === 'graded' && submission.grade !== null);
            
            const matchesSearch = !searchTerm || 
                submission.student_name.toLowerCase().includes(searchTerm) ||
                submission.student_email.toLowerCase().includes(searchTerm);
            
            return matchesStatus && matchesSearch;
        });

        // Sort submissions
        this.filteredSubmissions.sort((a, b) => {
            switch (sortBy) {
                case 'submitted_at':
                    return new Date(b.submitted_at) - new Date(a.submitted_at);
                case 'student_name':
                    return a.student_name.localeCompare(b.student_name);
                case 'grade':
                    return (b.grade || 0) - (a.grade || 0);
                default:
                    return 0;
            }
        });

        this.renderSubmissions();
    }

    renderSubmissions() {
        const container = document.getElementById('submissionsContainer');
        const emptyState = document.getElementById('emptyState');

        if (this.filteredSubmissions.length === 0) {
            container.classList.add('hidden');
            emptyState.classList.remove('hidden');
            return;
        }

        container.classList.remove('hidden');
        emptyState.classList.add('hidden');

        container.innerHTML = this.filteredSubmissions.map(submission => this.renderSubmissionCard(submission)).join('');
    }

    renderSubmissionCard(submission) {
        const submittedDate = new Date(submission.submitted_at).toLocaleDateString();
        const isGraded = submission.grade !== null;
        const gradePercent = isGraded ? ((submission.grade / {{ assignment.max_score }}) * 100).toFixed(1) : null;
        
        return `
            <div class="bg-white rounded-lg shadow border ${isGraded ? 'border-green-200 bg-green-50' : 'border-gray-200'}">
                <div class="p-6">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="flex items-center space-x-3">
                                <h4 class="text-lg font-medium text-gray-900">${submission.student_name}</h4>
                                <span class="text-sm text-gray-500">${submission.student_email}</span>
                                ${isGraded ? `
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                        ${submission.grade}/${{'{{ assignment.max_score }}'}} (${gradePercent}%)
                                    </span>
                                ` : `
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                        Pending
                                    </span>
                                `}
                            </div>
                            <div class="mt-2 text-sm text-gray-500">
                                <span>Submitted: ${submittedDate}</span>
                                ${submission.graded_at ? `<span class="ml-4">Graded: ${new Date(submission.graded_at).toLocaleDateString()}</span>` : ''}
                            </div>
                            ${submission.feedback ? `
                                <div class="mt-2 text-sm text-gray-600 bg-gray-50 p-3 rounded-md">
                                    <strong>Feedback:</strong> ${submission.feedback}
                                </div>
                            ` : ''}
                        </div>
                        <div class="flex items-center space-x-3">
                            <button onclick="window.location.href='/teachers/grading/submission/${submission.id}'" 
                                    class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">
                                ${isGraded ? 'Review' : 'Grade'}
                            </button>
                            ${!isGraded ? `
                                <button onclick="gradingApp.aiGradeSubmission(${submission.id})" 
                                        class="inline-flex items-center px-3 py-2 border border-purple-300 text-sm font-medium rounded-md text-purple-700 bg-white hover:bg-purple-50">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                    </svg>
                                    AI Grade
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    async aiGradeSubmission(submissionId) {
        try {
            const response = await fetch(`/api/teachers/submissions/${submissionId}/ai-grade`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
            });
            
            const data = await response.json();
            
            if (data.success) {
                const aiGrading = data.ai_grading;
                const confirmGrade = confirm(
                    `AI suggests grade: ${aiGrading.suggested_grade}/${{'{{ assignment.max_score }}'}}\n\n` +
                    `Feedback: ${aiGrading.feedback}\n\n` +
                    `Confidence: ${(aiGrading.confidence * 100).toFixed(0)}%\n\n` +
                    `Apply this grade?`
                );
                
                if (confirmGrade) {
                    await this.applyGrade(submissionId, aiGrading.suggested_grade, aiGrading.feedback);
                }
            } else {
                alert('AI grading failed: ' + data.message);
            }
        } catch (error) {
            console.error('Error with AI grading:', error);
            alert('Network error during AI grading');
        }
    }

    async applyGrade(submissionId, grade, feedback) {
        try {
            const response = await fetch(`/api/teachers/submissions/${submissionId}/grade`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ grade, feedback })
            });
            
            if (response.ok) {
                // Reload submissions to show updated grade
                await this.loadSubmissions();
            } else {
                alert('Failed to save grade');
            }
        } catch (error) {
            console.error('Error applying grade:', error);
            alert('Network error saving grade');
        }
    }

    async startAiGrading() {
        const ungradedSubmissions = this.submissions.filter(s => s.grade === null);
        
        if (ungradedSubmissions.length === 0) {
            alert('No ungraded submissions found');
            return;
        }
        
        const confirm = window.confirm(
            `This will use AI to grade ${ungradedSubmissions.length} submissions. ` +
            `You can review and modify grades afterwards. Continue?`
        );
        
        if (!confirm) return;
        
        this.showAiGradingModal();
        // Implement AI grading logic here
    }

    showAiGradingModal() {
        document.getElementById('aiGradingModal').classList.remove('hidden');
    }

    closeAiGradingModal() {
        document.getElementById('aiGradingModal').classList.add('hidden');
    }

    updateSubmissionCount() {
        const total = this.submissions.length;
        const graded = this.submissions.filter(s => s.grade !== null).length;
        document.getElementById('submissionCount').textContent = `${graded}/${total} graded`;
    }

    showLoading(show) {
        const loadingState = document.getElementById('loadingState');
        const submissionsContainer = document.getElementById('submissionsContainer');
        const emptyState = document.getElementById('emptyState');

        if (show) {
            loadingState.classList.remove('hidden');
            submissionsContainer.classList.add('hidden');
            emptyState.classList.add('hidden');
        } else {
            loadingState.classList.add('hidden');
        }
    }

    showError(message) {
        alert(`Error: ${message}`);
    }

    exportGrades() {
        // Implement grade export functionality
        window.open(`/api/teachers/assignments/${this.assignmentId}/export-grades`);
    }
}

// Make instance available globally
let gradingApp;
document.addEventListener('DOMContentLoaded', () => {
    gradingApp = new AssignmentGrading();
});
</script>
{% endblock %}