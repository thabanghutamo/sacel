{% extends "base/layout.html" %}

{% block title %}Application Status - SACEL{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Check Application Status</h1>
            <p class="mt-2 text-lg text-gray-600">Enter your reference number to view your application status</p>
        </div>

        <!-- Search Form -->
        <div class="bg-white shadow-lg rounded-lg p-8 mb-8">
            <form id="statusForm" onsubmit="checkStatus(event)" class="max-w-md mx-auto">
                <div class="mb-4">
                    <label for="reference_number" class="block text-sm font-medium text-gray-700 mb-2">
                        Reference Number
                    </label>
                    <input type="text" id="reference_number" name="reference_number" required
                           placeholder="e.g., SACEL202412345ABC"
                           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <p class="mt-1 text-sm text-gray-500">Enter the reference number you received when submitting your application</p>
                </div>
                
                <button type="submit" id="checkBtn"
                        class="w-full bg-blue-600 text-white rounded-md py-2 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    Check Status
                </button>
            </form>
        </div>

        <!-- Status Display -->
        <div id="statusResult" class="hidden">
            <div class="bg-white shadow-lg rounded-lg overflow-hidden">
                <!-- Status Header -->
                <div id="statusHeader" class="px-8 py-6 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 id="studentName" class="text-xl font-semibold text-gray-900"></h2>
                            <p id="schoolInfo" class="text-gray-600"></p>
                        </div>
                        <div id="statusBadge" class="px-4 py-2 rounded-full text-sm font-medium"></div>
                    </div>
                </div>

                <!-- Application Details -->
                <div class="px-8 py-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="text-lg font-medium text-gray-900 mb-4">Application Details</h3>
                            <dl class="space-y-2">
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">Reference Number</dt>
                                    <dd id="refNumber" class="text-sm text-gray-900 font-mono"></dd>
                                </div>
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">Grade Applying For</dt>
                                    <dd id="gradeInfo" class="text-sm text-gray-900"></dd>
                                </div>
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">Submitted</dt>
                                    <dd id="submittedDate" class="text-sm text-gray-900"></dd>
                                </div>
                                <div id="reviewedDateContainer" class="hidden">
                                    <dt class="text-sm font-medium text-gray-500">Reviewed</dt>
                                    <dd id="reviewedDate" class="text-sm text-gray-900"></dd>
                                </div>
                            </dl>
                        </div>

                        <div>
                            <h3 class="text-lg font-medium text-gray-900 mb-4">Documents</h3>
                            <div id="documentsInfo">
                                <p class="text-sm text-gray-500">Loading document information...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Status Timeline -->
                    <div class="mt-8">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Application Timeline</h3>
                        <div id="timeline" class="space-y-4">
                            <!-- Timeline items will be inserted here -->
                        </div>
                    </div>

                    <!-- Notes -->
                    <div id="notesSection" class="mt-8 hidden">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Notes from School</h3>
                        <div id="notesContent" class="bg-gray-50 rounded-lg p-4">
                            <!-- Notes content will be inserted here -->
                        </div>
                    </div>

                    <!-- Next Steps -->
                    <div class="mt-8 bg-blue-50 border border-blue-200 rounded-lg p-6">
                        <h3 class="text-lg font-medium text-blue-900 mb-2">Next Steps</h3>
                        <div id="nextSteps" class="text-sm text-blue-800">
                            <!-- Next steps will be inserted based on status -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error Display -->
        <div id="errorDisplay" class="hidden bg-red-50 border border-red-200 rounded-lg p-6">
            <div class="flex items-center">
                <svg class="w-5 h-5 text-red-400 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <p id="errorMessage" class="text-red-800"></p>
            </div>
        </div>
    </div>
</div>

<script>
async function checkStatus(event) {
    event.preventDefault();
    
    const checkBtn = document.getElementById('checkBtn');
    const referenceNumber = document.getElementById('reference_number').value.trim();
    
    if (!referenceNumber) {
        showError('Please enter a reference number');
        return;
    }
    
    checkBtn.disabled = true;
    checkBtn.textContent = 'Checking...';
    
    hideError();
    hideStatus();
    
    try {
        const response = await fetch(`/api/admissions/status/${referenceNumber}`);
        const data = await response.json();
        
        if (response.ok) {
            displayStatus(data);
        } else {
            showError(data.error || 'Application not found');
        }
    } catch (error) {
        console.error('Error checking status:', error);
        showError('An error occurred while checking the status. Please try again.');
    } finally {
        checkBtn.disabled = false;
        checkBtn.textContent = 'Check Status';
    }
}

function displayStatus(data) {
    // Hide error and show status
    hideError();
    document.getElementById('statusResult').classList.remove('hidden');
    
    // Update basic info
    document.getElementById('studentName').textContent = data.student_name;
    document.getElementById('schoolInfo').textContent = `${data.school_name} - Grade ${data.grade}`;
    document.getElementById('refNumber').textContent = data.reference_number;
    document.getElementById('gradeInfo').textContent = `Grade ${data.grade}`;
    
    // Format and display dates
    if (data.submitted_at) {
        const submittedDate = new Date(data.submitted_at).toLocaleDateString('en-ZA', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        document.getElementById('submittedDate').textContent = submittedDate;
    }
    
    if (data.reviewed_at) {
        const reviewedDate = new Date(data.reviewed_at).toLocaleDateString('en-ZA', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        document.getElementById('reviewedDate').textContent = reviewedDate;
        document.getElementById('reviewedDateContainer').classList.remove('hidden');
    }
    
    // Update status badge
    updateStatusBadge(data.status);
    
    // Update documents info
    updateDocumentsInfo(data.documents);
    
    // Update timeline
    updateTimeline(data);
    
    // Show notes if available
    if (data.notes && data.notes.trim()) {
        document.getElementById('notesContent').textContent = data.notes;
        document.getElementById('notesSection').classList.remove('hidden');
    }
    
    // Update next steps
    updateNextSteps(data.status);
}

function updateStatusBadge(status) {
    const badge = document.getElementById('statusBadge');
    const statusConfig = {
        'submitted': { text: 'Submitted', classes: 'bg-blue-100 text-blue-800' },
        'under_review': { text: 'Under Review', classes: 'bg-yellow-100 text-yellow-800' },
        'approved': { text: 'Approved', classes: 'bg-green-100 text-green-800' },
        'rejected': { text: 'Rejected', classes: 'bg-red-100 text-red-800' },
        'waitlisted': { text: 'Waitlisted', classes: 'bg-orange-100 text-orange-800' }
    };
    
    const config = statusConfig[status] || { text: status, classes: 'bg-gray-100 text-gray-800' };
    badge.textContent = config.text;
    badge.className = `px-4 py-2 rounded-full text-sm font-medium ${config.classes}`;
}

function updateDocumentsInfo(documents) {
    const container = document.getElementById('documentsInfo');
    
    if (!documents || documents.length === 0) {
        container.innerHTML = '<p class="text-sm text-gray-500">No documents uploaded yet</p>';
        return;
    }
    
    const documentList = documents.map(doc => `
        <div class="flex items-center text-sm text-gray-600 mb-1">
            <svg class="w-4 h-4 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            ${doc}
        </div>
    `).join('');
    
    container.innerHTML = documentList;
}

function updateTimeline(data) {
    const timeline = document.getElementById('timeline');
    const timelineItems = [];
    
    // Submitted
    if (data.submitted_at) {
        timelineItems.push({
            title: 'Application Submitted',
            date: data.submitted_at,
            completed: true,
            description: 'Your application has been received and is in the system.'
        });
    }
    
    // Under Review
    if (data.status === 'under_review' || data.reviewed_at) {
        timelineItems.push({
            title: 'Under Review',
            date: data.reviewed_at,
            completed: data.status !== 'submitted',
            description: 'School staff are reviewing your application and documents.'
        });
    }
    
    // Final Status
    if (['approved', 'rejected', 'waitlisted'].includes(data.status)) {
        const statusTexts = {
            'approved': 'Application Approved',
            'rejected': 'Application Rejected',
            'waitlisted': 'Added to Waitlist'
        };
        
        timelineItems.push({
            title: statusTexts[data.status],
            date: data.reviewed_at,
            completed: true,
            description: getStatusDescription(data.status)
        });
    }
    
    timeline.innerHTML = timelineItems.map(item => `
        <div class="flex items-start">
            <div class="flex-shrink-0">
                <div class="w-8 h-8 rounded-full flex items-center justify-center ${
                    item.completed ? 'bg-green-500' : 'bg-gray-300'
                }">
                    ${item.completed 
                        ? '<svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>'
                        : '<div class="w-2 h-2 bg-white rounded-full"></div>'
                    }
                </div>
            </div>
            <div class="ml-4 flex-1">
                <h4 class="text-sm font-medium text-gray-900">${item.title}</h4>
                <p class="text-sm text-gray-600">${item.description}</p>
                ${item.date ? `<p class="text-xs text-gray-500 mt-1">${new Date(item.date).toLocaleDateString('en-ZA')}</p>` : ''}
            </div>
        </div>
    `).join('');
}

function getStatusDescription(status) {
    const descriptions = {
        'approved': 'Congratulations! Your application has been approved. You will receive further instructions via email.',
        'rejected': 'Unfortunately, your application was not successful this time. You may apply again next year.',
        'waitlisted': 'Your application is on the waitlist. You will be notified if a space becomes available.'
    };
    return descriptions[status] || '';
}

function updateNextSteps(status) {
    const nextSteps = document.getElementById('nextSteps');
    const steps = {
        'submitted': 'Your application is being processed. Please ensure you upload all required documents. You can check back here for updates.',
        'under_review': 'School staff are currently reviewing your application. Please be patient as this process can take several days.',
        'approved': 'Congratulations! Please check your email for enrollment instructions and required next steps.',
        'rejected': 'We appreciate your interest. If you have questions about the decision, you may contact the school directly.',
        'waitlisted': 'Please monitor your email and check this page regularly for updates on your waitlist status.'
    };
    
    nextSteps.textContent = steps[status] || 'Please contact the school if you have any questions.';
}

function showError(message) {
    document.getElementById('errorMessage').textContent = message;
    document.getElementById('errorDisplay').classList.remove('hidden');
}

function hideError() {
    document.getElementById('errorDisplay').classList.add('hidden');
}

function hideStatus() {
    document.getElementById('statusResult').classList.add('hidden');
}
</script>
{% endblock %}