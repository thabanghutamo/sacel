{% extends "base/layout.html" %}

{% block title %}Apply for Admission - SACEL{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900">School Admission Application</h1>
            <p class="mt-2 text-lg text-gray-600">Complete the form below to apply for admission</p>
        </div>

        <!-- Progress Indicator -->
        <div class="mb-8">
            <div class="flex items-center justify-center">
                <div class="flex items-center">
                    <div class="flex items-center text-blue-600">
                        <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center">
                            <span class="text-white text-sm font-medium">1</span>
                        </div>
                        <span class="ml-2 text-sm font-medium">Application</span>
                    </div>
                    <div class="w-12 h-0.5 bg-gray-300 mx-4"></div>
                    <div class="flex items-center text-gray-500">
                        <div class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center">
                            <span class="text-gray-600 text-sm font-medium">2</span>
                        </div>
                        <span class="ml-2 text-sm font-medium">Documents</span>
                    </div>
                    <div class="w-12 h-0.5 bg-gray-300 mx-4"></div>
                    <div class="flex items-center text-gray-500">
                        <div class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center">
                            <span class="text-gray-600 text-sm font-medium">3</span>
                        </div>
                        <span class="ml-2 text-sm font-medium">Review</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Application Form -->
        <div class="bg-white shadow-lg rounded-lg overflow-hidden">
            <form id="applicationForm" class="p-8 space-y-6" onsubmit="submitApplication(event)">
                <!-- School Selection -->
                <div>
                    <label for="school_id" class="block text-sm font-medium text-gray-700 mb-2">
                        Select School *
                    </label>
                    <select id="school_id" name="school_id" required 
                            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Choose a school...</option>
                        <!-- Schools will be loaded via JavaScript -->
                    </select>
                </div>

                <!-- Student Information -->
                <div class="bg-gray-50 p-6 rounded-lg">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Student Information</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="student_first_name" class="block text-sm font-medium text-gray-700 mb-1">
                                First Name *
                            </label>
                            <input type="text" id="student_first_name" name="student_first_name" required
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label for="student_last_name" class="block text-sm font-medium text-gray-700 mb-1">
                                Last Name *
                            </label>
                            <input type="text" id="student_last_name" name="student_last_name" required
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label for="student_birth_date" class="block text-sm font-medium text-gray-700 mb-1">
                                Date of Birth *
                            </label>
                            <input type="date" id="student_birth_date" name="student_birth_date" required
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label for="grade_applying_for" class="block text-sm font-medium text-gray-700 mb-1">
                                Grade Applying For *
                            </label>
                            <select id="grade_applying_for" name="grade_applying_for" required
                                    class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Select grade...</option>
                                <option value="1">Grade 1</option>
                                <option value="2">Grade 2</option>
                                <option value="3">Grade 3</option>
                                <option value="4">Grade 4</option>
                                <option value="5">Grade 5</option>
                                <option value="6">Grade 6</option>
                                <option value="7">Grade 7</option>
                                <option value="8">Grade 8</option>
                                <option value="9">Grade 9</option>
                                <option value="10">Grade 10</option>
                                <option value="11">Grade 11</option>
                                <option value="12">Grade 12</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <label for="previous_school" class="block text-sm font-medium text-gray-700 mb-1">
                            Previous School
                        </label>
                        <input type="text" id="previous_school" name="previous_school"
                               class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>

                <!-- Parent/Guardian Information -->
                <div class="bg-gray-50 p-6 rounded-lg">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Parent/Guardian Information</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="parent_first_name" class="block text-sm font-medium text-gray-700 mb-1">
                                First Name *
                            </label>
                            <input type="text" id="parent_first_name" name="parent_first_name" required
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label for="parent_last_name" class="block text-sm font-medium text-gray-700 mb-1">
                                Last Name *
                            </label>
                            <input type="text" id="parent_last_name" name="parent_last_name" required
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label for="parent_email" class="block text-sm font-medium text-gray-700 mb-1">
                                Email Address *
                            </label>
                            <input type="email" id="parent_email" name="parent_email" required
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label for="parent_phone" class="block text-sm font-medium text-gray-700 mb-1">
                                Phone Number *
                            </label>
                            <input type="tel" id="parent_phone" name="parent_phone" required
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <label for="address" class="block text-sm font-medium text-gray-700 mb-1">
                            Home Address
                        </label>
                        <textarea id="address" name="address" rows="3"
                                  class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                </div>

                <!-- Additional Information -->
                <div class="bg-gray-50 p-6 rounded-lg">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Additional Information</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label for="medical_conditions" class="block text-sm font-medium text-gray-700 mb-1">
                                Medical Conditions or Allergies
                            </label>
                            <textarea id="medical_conditions" name="medical_conditions" rows="3"
                                      placeholder="Please list any medical conditions, allergies, or special medical needs..."
                                      class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                        </div>
                        
                        <div>
                            <label for="special_requirements" class="block text-sm font-medium text-gray-700 mb-1">
                                Special Educational Requirements
                            </label>
                            <textarea id="special_requirements" name="special_requirements" rows="3"
                                      placeholder="Please describe any special educational needs or accommodations..."
                                      class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Terms and Conditions -->
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <div class="flex items-start">
                        <input type="checkbox" id="terms_accepted" name="terms_accepted" required
                               class="mt-1 mr-3 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                        <label for="terms_accepted" class="text-sm text-gray-700">
                            I confirm that all information provided is accurate and complete. I understand that providing false information may result in the rejection of this application. I agree to the school's terms and conditions and privacy policy. *
                        </label>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="flex justify-end space-x-4">
                    <button type="button" onclick="history.back()" 
                            class="px-6 py-3 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        Cancel
                    </button>
                    <button type="submit" id="submitBtn"
                            class="px-6 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50">
                        Submit Application
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg p-8 max-w-md mx-4">
        <div class="text-center">
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 mb-2">Application Submitted!</h3>
            <p class="text-gray-600 mb-4">Your application has been submitted successfully.</p>
            <p class="text-sm text-gray-500 mb-6">
                Reference Number: <span id="referenceNumber" class="font-mono font-bold"></span>
            </p>
            <button onclick="closeSuccessModal()" 
                    class="w-full bg-blue-600 text-white rounded-md py-2 hover:bg-blue-700">
                Continue
            </button>
        </div>
    </div>
</div>

<script>
// Load schools on page load
document.addEventListener('DOMContentLoaded', function() {
    loadSchools();
});

async function loadSchools() {
    try {
        const response = await fetch('/api/schools/list');
        const schools = await response.json();
        
        const select = document.getElementById('school_id');
        select.innerHTML = '<option value="">Choose a school...</option>';
        
        schools.forEach(school => {
            if (school.admission_open) {
                const option = document.createElement('option');
                option.value = school.id;
                option.textContent = `${school.name} (${school.city})`;
                select.appendChild(option);
            }
        });
    } catch (error) {
        console.error('Error loading schools:', error);
    }
}

async function submitApplication(event) {
    event.preventDefault();
    
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Submitting...';
    
    try {
        const formData = new FormData(event.target);
        const data = Object.fromEntries(formData.entries());
        
        const response = await fetch('/api/admissions/submit', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            document.getElementById('referenceNumber').textContent = result.reference_number;
            document.getElementById('successModal').classList.remove('hidden');
            document.getElementById('successModal').classList.add('flex');
        } else {
            alert('Error: ' + (result.message || result.error));
        }
    } catch (error) {
        console.error('Error submitting application:', error);
        alert('An error occurred while submitting your application. Please try again.');
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Application';
    }
}

function closeSuccessModal() {
    document.getElementById('successModal').classList.add('hidden');
    document.getElementById('successModal').classList.remove('flex');
    window.location.href = '/';
}
</script>
{% endblock %}
